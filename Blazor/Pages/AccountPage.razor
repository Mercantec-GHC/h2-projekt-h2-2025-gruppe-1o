@page "/account"
@attribute [Authorize]
@using DomainModels.DTOs
@using System.Security.Claims
@using DomainModels.Enums
@inject NavigationManager Navigation
@inject APIService ApiService

<PageTitle>Min Konto</PageTitle>

<div class="page-section">
    <PageHeader Title="Min Konto" Subtitle="@($"Velkommen, {user?.Identity?.Name}! Her kan du administrere dine oplysninger, bookinger og supportsager.")" />

    <div class="account-grid">
        <div class="account-card">
            <h3 class="card-title">Mine Oplysninger</h3>
            @if (_isLoadingBookings)
            {
                <p>Henter oplysninger...</p>
            }
            else if (_isEditingInfo)
            {
                <EditForm Model="_userUpdateDto" OnValidSubmit="HandleUpdateInfo">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger" />

                    @if (!string.IsNullOrEmpty(_updateInfoMessage))
                    {
                        <div class="alert @(_updateInfoSuccess ? "alert-success" : "alert-danger")" role="alert">
                            @_updateInfoMessage
                        </div>
                    }

                    <div class="form-group">
                        <label>Fornavn</label>
                        <InputText class="form-control" @bind-Value="_userUpdateDto.FirstName" />
                    </div>
                    <div class="form-group">
                        <label>Efternavn</label>
                        <InputText class="form-control" @bind-Value="_userUpdateDto.LastName" />
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <InputText class="form-control" @bind-Value="_userUpdateDto.Email" />
                    </div>
                    <div class="form-group">
                        <label>Telefon nr.</label>
                        <InputText class="form-control" @bind-Value="_userUpdateDto.PhoneNumber" />
                    </div>
                    <ActionButton Type="ActionButton.ButtonType.Primary" IsSubmit="true">Gem Oplysninger</ActionButton>
                    <ActionButton Type="ActionButton.ButtonType.Secondary" OnClick="ToggleEditMode">Annuller</ActionButton>
                </EditForm>
            }
            else if (_userDetailDto != null)
            {
                <div class="info-display">
                    <p><strong>Fornavn:</strong> @_userDetailDto.FirstName</p>
                    <p><strong>Efternavn:</strong> @_userDetailDto.LastName</p>
                    <p><strong>Email:</strong> @_userDetailDto.Email</p>
                    <p><strong>Telefon nr.:</strong> @_userDetailDto.PhoneNumber</p>
                    <ActionButton Type="ActionButton.ButtonType.Primary" OnClick="ToggleEditMode">Rediger</ActionButton>
                </div>
            }
        </div>

        <AuthorizeView Roles="User">
            <div class="account-card">
                <h3 class="card-title">Sikkerhed</h3>
                <EditForm Model="_changePasswordDto" OnValidSubmit="HandleChangePassword" Context="formContext">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger" />

                    @if (!string.IsNullOrEmpty(_passwordChangeMessage))
                    {
                        <div class="alert @(_passwordChangeSuccess ? "alert-success" : "alert-danger")" role="alert">
                            @_passwordChangeMessage
                        </div>
                    }

                    <div class="form-group">
                        <label>Nuværende adgangskode</label>
                        <InputText type="password" class="form-control" @bind-Value="_changePasswordDto.CurrentPassword" />
                    </div>
                    <div class="form-group">
                        <label>Ny adgangskode</label>
                        <InputText type="password" class="form-control" @bind-Value="_changePasswordDto.NewPassword" />
                    </div>
                    <div class="form-group">
                        <label>Bekræft ny adgangskode</label>
                        <InputText type="password" class="form-control" @bind-Value="_changePasswordDto.ConfirmNewPassword" />
                    </div>
                    <ActionButton Type="ActionButton.ButtonType.Primary" IsSubmit="true">Skift Adgangskode</ActionButton>
                </EditForm>
            </div>
        </AuthorizeView>

        <div class="account-card full-width">
            <h3 class="card-title">Mine Sager</h3>
            @if (_isLoadingTickets)
            {
                <p>Henter sager...</p>
            }
            else if (OpenTickets.Any())
            {
                <ul class="booking-list">
                    @foreach (var ticket in OpenTickets)
                    {
                        <li @onclick="@(() => Navigation.NavigateTo($"/support/ticket/{ticket.Id}"))" style="cursor: pointer;">
                            <span class="booking-room">@ticket.Title</span>
                            <span class="booking-dates">@ticket.CreatedAt.ToString("dd-MM-yyyy HH:mm")</span>
                            <StatusBadge Status="@ticket.Status" />
                        </li>
                    }
                </ul>
            }
            else
            {
                <p>Du har ingen åbne supportsager. <a href="/support/new">Opret en ny sag</a></p>
            }
        </div>

        <div class="account-card full-width">
            <h3 class="card-title">Mine Bookinger</h3>
            @if (_isLoadingBookings)
            {
                <p>Henter bookinger...</p>
            }
            else if (_myBookings != null && _myBookings.Any())
            {
                <ul class="booking-list">
                    @foreach (var booking in _myBookings.OrderBy(b => b.CheckInDate))
                    {
                        <li>
                            <span class="booking-room">@booking.RoomTypeName</span>
                            <span class="booking-dates">@booking.CheckInDate.ToString("dd/MM/yyyy") - @booking.CheckOutDate.ToString("dd/MM/yyyy")</span>
                            <StatusBadge Status="@booking.Status" />
                        </li>
                    }
                </ul>
            }
            else
            {
                <p>Du har ingen bookinger endnu.</p>
            }
        </div>
    </div>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private ClaimsPrincipal? user;

    private List<BookingGetDto> _myBookings = new();
    private bool _isLoadingBookings = true;

    private List<TicketSummaryDto> _myTickets = new();
    private bool _isLoadingTickets = true;

    private IEnumerable<TicketSummaryDto> OpenTickets =>
        _myTickets.Where(t => t.Status != TicketStatus.Closed).OrderByDescending(t => t.CreatedAt);

    private bool _isEditingInfo = false;
    private UserDetailDto? _userDetailDto;
    private UserUpdateDto _userUpdateDto = new();
    private string? _updateInfoMessage;
    private bool _updateInfoSuccess = false;

    private ChangePasswordDto _changePasswordDto = new();
    private string? _passwordChangeMessage;
    private bool _passwordChangeSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateTask;
        user = authState.User;

        if (user?.Identity?.IsAuthenticated ?? false)
        {
            var bookingsTask = ApiService.GetMyBookingsAsync();
            var userDetailsTask = ApiService.GetMyDetailsAsync();
            var ticketsTask = ApiService.GetMyTicketsAsync();

            await Task.WhenAll(bookingsTask, userDetailsTask, ticketsTask);

            _myBookings = bookingsTask.Result ?? new();
            _userDetailDto = userDetailsTask.Result;
            _myTickets = ticketsTask.Result ?? new();

            if (_userDetailDto != null)
            {
                _userUpdateDto = new UserUpdateDto
                {
                    FirstName = _userDetailDto.FirstName,
                    LastName = _userDetailDto.LastName,
                    Email = _userDetailDto.Email,
                    PhoneNumber = _userDetailDto.PhoneNumber
                };
            }
        }
        _isLoadingBookings = false;
        _isLoadingTickets = false;
    }

    private void ToggleEditMode()
    {
        _updateInfoMessage = null;
        if (_userDetailDto != null)
        {
            _userUpdateDto = new UserUpdateDto
            {
                FirstName = _userDetailDto.FirstName,
                LastName = _userDetailDto.LastName,
                Email = _userDetailDto.Email,
                PhoneNumber = _userDetailDto.PhoneNumber
            };
        }
        _isEditingInfo = !_isEditingInfo;
    }

    private async Task HandleUpdateInfo()
    {
        _updateInfoMessage = null;
        if (user == null || _userDetailDto == null) return;

        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (userId == null) return;

        var (success, errorMessage) = await ApiService.UpdateMyDetailsAsync(userId, _userUpdateDto);
        _updateInfoSuccess = success;
        if (success)
        {
            _updateInfoMessage = "Dine oplysninger er blevet opdateret.";
            _userDetailDto.FirstName = _userUpdateDto.FirstName;
            _userDetailDto.LastName = _userUpdateDto.LastName;
            _userDetailDto.Email = _userUpdateDto.Email;
            _userDetailDto.PhoneNumber = _userUpdateDto.PhoneNumber ?? string.Empty;
            _isEditingInfo = false;
        }
        else
        {
            _updateInfoMessage = $"Fejl: {errorMessage}";
        }
    }

    private async Task HandleChangePassword()
    {
        _passwordChangeMessage = null;
        if (_changePasswordDto == null) return;

        var (success, errorMessage) = await ApiService.ChangePasswordAsync(_changePasswordDto);
        _passwordChangeSuccess = success;
        if (success)
        {
            _passwordChangeMessage = "Din adgangskode er blevet ændret.";
            _changePasswordDto = new();
        }
        else
        {
            _passwordChangeMessage = $"Fejl: {errorMessage}";
        }
    }
}