@page "/admin"
@layout MainLayout
@attribute [Authorize(Roles = "Receptionist, Manager")]
@using DomainModels.DTOs
@using System.Globalization
@using DomainModels.Enums
@using System.Security.Claims
@inject APIService ApiService
@inject TicketSignalRService SignalRService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Management Dashboard</PageTitle>

<div class="booking-management-page">
    <PageHeader Title="Booking Management" Subtitle="Oversigt over bookinger, gæsteaktivitet og support." />

    @if (!string.IsNullOrEmpty(_statusMessage))
    {
        <div class="alert @(_isStatusSuccess ? "alert-success" : "alert-danger")" role="alert">
            @_statusMessage
        </div>
    }

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label class="form-label fw-semibold">Søg i bookinger</label>
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Booking ID, gæstenavn..." @bind="_searchTerm" @oninput="ApplyFilters" />
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Vis dato</label>
                    <InputDate class="form-control" @bind-Value="_dateFilter" @bind-Value:after="ApplyFilters" />
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Status</label>
                    <select class="form-select" @bind="_statusFilter" @bind:after="ApplyFilters">
                        <option value="">Alle status</option>
                        <option value="Confirmed">Bekræftet</option>
                        <option value="CheckedIn">Checket Ind</option>
                        <option value="CheckedOut">Checket Ud</option>
                        <option value="Cancelled">Annulleret</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" @onclick="ClearFilters">Nulstil</button>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "arrivals" ? "active" : "")" @onclick='() => SetActiveTab("arrivals")'>Dagens Ankomster (@_arrivals.Count)</button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "departures" ? "active" : "")" @onclick='() => SetActiveTab("departures")'>Dagens Afrejser (@_departures.Count)</button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "all" ? "active" : "")" @onclick='() => SetActiveTab("all")'>Alle Bookinger (@GetVisibleBookings().Count)</button>
        </li>
    </ul>

    @if (_isLoading)
    {
        <p><em>Henter data...</em></p>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Booking ID</th>
                        <th>Gæstenavn</th>
                        <th>Værelse</th>
                        <th>Check-in</th>
                        <th>Check-ud</th>
                        <th>Status</th>
                        <th class="text-end">Handlinger</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var booking in GetVisibleBookings())
                    {
                        <tr>
                            <td>#@booking.Id.Substring(0, 6).ToUpper()</td>
                            <td>@booking.GuestFullName</td>
                            <td>@booking.RoomTypeName</td>
                            <td>@booking.CheckInDate.ToString("dd/MM/yyyy")</td>
                            <td>@booking.CheckOutDate.ToString("dd/MM/yyyy")</td>
                            <td><StatusBadge Status="@booking.Status" /></td>
                            <td class="text-end">
                                @if (booking.Status == "Confirmed" && booking.CheckInDate.Date == DateTime.UtcNow.Date)
                                {
                                    <ActionButton Type="ActionButton.ButtonType.Primary" OnClick="@(() => HandleStatusUpdate(booking.Id, "CheckedIn"))" Disabled="@_isSubmitting">
                                        Check-in
                                    </ActionButton>
                                }
                                else if (booking.Status == "CheckedIn" && booking.CheckOutDate.Date == DateTime.UtcNow.Date)
                                {
                                    <ActionButton Type="ActionButton.ButtonType.Secondary" OnClick="@(() => HandleStatusUpdate(booking.Id, "CheckedOut"))" Disabled="@_isSubmitting">
                                        Check-ud
                                    </ActionButton>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    <AuthorizeView Roles="Receptionist">
        <hr class="my-5" />
        <WalkInBooking AvailableRoomTypes="_roomTypeAvailability" OnBookingCreated="ReloadData" />

        <hr class="my-5" />
        <PageHeader Title="Værelsesstatus & Housekeeping" Subtitle="Se status på alle hotellets værelser og anmod om rengøring." />

        @if (_allPhysicalRooms == null)
        {
            <p><em>Indlæser værelsesliste...</em></p>
        }
        else
        {
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" placeholder="Søg på værelsesnummer..." @bind="_housekeepingSearchTerm" @bind:event="oninput" />
                    </div>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Værelse</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th class="text-end">Handling</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var room in FilteredPhysicalRooms)
                                {
                                    <tr>
                                        <td>@room.RoomNumber</td>
                                        <td>@room.RoomTypeName</td>
                                        <td><StatusBadge Status="@room.Status" /></td>
                                        <td class="text-end">
                                            <button class="btn btn-sm btn-outline-primary"
                                                    disabled="@(room.Status == "NeedsCleaning")"
                                                    @onclick="() => RequestCleaning(room.Id)">
                                                Anmod om Rengøring
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    </AuthorizeView>

    <AuthorizeView Roles="Manager">
        <h2 class="mt-5 mb-3">Dagens Statistik</h2>
        @if (_stats != null)
        {
            <div class="row">
                <div class="col-md-3"><div class="card text-center shadow-sm h-100"><div class="card-body"><i class="bi bi-box-arrow-in-right fs-1 text-primary"></i><h4 class="mt-2">@_stats.ArrivalsCount</h4><p class="text-muted mb-0">Ankomster</p></div></div></div>
                <div class="col-md-3"><div class="card text-center shadow-sm h-100"><div class="card-body"><i class="bi bi-box-arrow-left fs-1 text-primary"></i><h4 class="mt-2">@_stats.DeparturesCount</h4><p class="text-muted mb-0">Afrejser</p></div></div></div>
                <div class="col-md-3"><div class="card text-center shadow-sm h-100"><div class="card-body"><i class="bi bi-building fs-1 text-primary"></i><h4 class="mt-2">@_stats.OccupancyPercentage %</h4><p class="text-muted mb-0">Belægning</p></div></div></div>
                <div class="col-md-3"><div class="card text-center shadow-sm h-100"><div class="card-body"><i class="bi bi-cash-stack fs-1 text-primary"></i><h4 class="mt-2">@_stats.TodaysRevenue.ToString("N0") kr.</h4><p class="text-muted mb-0">Omsætning</p></div></div></div>
            </div>
        }
        <div class="d-flex justify-content-between align-items-center mt-5 mb-3">
            <h2 class="mb-0">Support Sager</h2>
            <ActionButton OnClick="@(() => Navigation.NavigateTo("/support/new"))">Opret Ny Sag</ActionButton>
        </div>
        <div class="row">
            <div class="col-md-6">
                <OpenTicketsList />
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Lukkede Support Sager</div>
                    <div class="card-body">
                        @if (_closedTickets == null)
                        {
                            <p><em>Indlæser...</em></p>
                        }
                        else if (!_closedTickets.Any())
                        {
                            <p>Ingen lukkede sager fundet.</p>
                        }
                        else
                        {
                            <ul class="list-group list-group-flush">
                                @foreach (var ticket in _closedTickets)
                                {
                                    <li class="list-group-item list-group-item-action" style="cursor:pointer;" @onclick="@(() => Navigation.NavigateTo($"/support/ticket/{ticket.Id}"))">
                                        #@ticket.Id.Substring(0, 6).ToUpper() - @ticket.Title
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                </div>
            </div>
        </div>
    </AuthorizeView>
</div>

@code {
    private bool _isLoading = true;
    private string _activeTab = "arrivals";
    private List<BookingSummaryDto> _allBookings = new();
    private List<BookingSummaryDto> _arrivals = new();
    private List<BookingSummaryDto> _departures = new();
    private string? _statusMessage;
    private bool _isStatusSuccess;
    private bool _isSubmitting;
    private DailyStatsDto? _stats;
    private List<TicketSummaryDto>? _closedTickets;
    private string _searchTerm = "";
    private DateTime? _dateFilter;
    private string _statusFilter = "";
    private List<RoomTypeCardDto>? _roomTypeAvailability;
    private List<RoomGetDto>? _allPhysicalRooms;
    private string _housekeepingSearchTerm = "";

    private IEnumerable<RoomGetDto> FilteredPhysicalRooms => _allPhysicalRooms?.Where(r => string.IsNullOrWhiteSpace(_housekeepingSearchTerm) || r.RoomNumber.Contains(_housekeepingSearchTerm, StringComparison.OrdinalIgnoreCase)) ?? Enumerable.Empty<RoomGetDto>();

    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; } = default!;
    private ClaimsPrincipal? _user;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateTask;
        _user = authState.User;

        var token = await ApiService.GetAuthTokenAsync();
        await SignalRService.StartConnectionAsync(token);
        SignalRService.OnNewTicketReceived += ReloadManagerTicketsWrapper;
        SignalRService.OnStatusChanged += ReloadManagerTicketsWrapper;
        SignalRService.OnRoomStatusChanged += HandleRoomStatusChanged;

        await ReloadData();
    }

    private async Task ReloadData()
    {
        if (_user is null) return;
        await LoadData(_user);
        StateHasChanged();
    }

    private async Task LoadData(ClaimsPrincipal user)
    {
        _isLoading = true;
        var allBookingsTask = ApiService.GetBookingsForAdminAsync();
        Task<DailyStatsDto?>? statsTask = null;
        Task<List<TicketSummaryDto>?>? closedTicketsTask = null;
        Task<List<RoomTypeCardDto>?>? roomAvailabilityTask = null;
        Task<List<RoomGetDto>?>? allRoomsTask = null;

        if (user.IsInRole("Manager"))
        {
            statsTask = ApiService.GetDashboardStatsAsync();
            closedTicketsTask = ApiService.GetClosedTicketsForMyRoleAsync();
        }
        if (user.IsInRole("Receptionist") || user.IsInRole("Manager"))
        {
            roomAvailabilityTask = ApiService.GetRoomTypeAvailabilitySummaryAsync();
            allRoomsTask = ApiService.GetAllRoomsAsync();
        }

        await Task.WhenAll(allBookingsTask, statsTask ?? Task.CompletedTask, closedTicketsTask ?? Task.CompletedTask,
                           roomAvailabilityTask ?? Task.CompletedTask, allRoomsTask ?? Task.CompletedTask);

        _allBookings = allBookingsTask.Result ?? new();
        if (statsTask != null) _stats = await statsTask;
        if (closedTicketsTask != null) _closedTickets = await closedTicketsTask ?? new();
        if (roomAvailabilityTask != null) _roomTypeAvailability = await roomAvailabilityTask ?? new();
        if (allRoomsTask != null) _allPhysicalRooms = (await allRoomsTask ?? new()).OrderBy(r => r.RoomNumber).ToList();

        FilterLocalLists();
        _isLoading = false;
    }

    private async Task HandleStatusUpdate(string bookingId, string newStatus)
    {
        _isSubmitting = true;
        _statusMessage = null;
        var (success, message) = await ApiService.UpdateBookingStatusAsync(bookingId, newStatus);
        _isStatusSuccess = success;
        _statusMessage = message;
        if (success)
        {
            var booking = _allBookings.FirstOrDefault(b => b.Id == bookingId);
            if (booking != null)
            {
                booking.Status = newStatus;
            }
            FilterLocalLists();
        }
        _isSubmitting = false;
        StateHasChanged();
    }

    private async Task RequestCleaning(int roomId)
    {
        var success = await ApiService.RequestRoomCleaningAsync(roomId);
        if (success)
        {
            var room = _allPhysicalRooms?.FirstOrDefault(r => r.Id == roomId);
            if (room != null)
            {
                room.Status = "NeedsCleaning";
                StateHasChanged();
            }
        }
    }

    private async void HandleRoomStatusChanged(int roomId, string newStatus)
    {
        var room = _allPhysicalRooms?.FirstOrDefault(r => r.Id == roomId);
        if (room != null)
        {
            room.Status = newStatus;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async void ReloadManagerTicketsWrapper(TicketSummaryDto ticket) => await ReloadManagerTickets();
    private async void ReloadManagerTicketsWrapper(string ticketId, TicketStatus status) => await ReloadManagerTickets();
    private async Task ReloadManagerTickets()
    {
        var authState = await AuthStateTask;
        if (authState.User.IsInRole("Manager"))
        {
            _closedTickets = await ApiService.GetClosedTicketsForMyRoleAsync() ?? new();
            await InvokeAsync(StateHasChanged);
        }
    }

    private void SetActiveTab(string tabName) => _activeTab = tabName;

    private List<BookingSummaryDto> GetVisibleBookings()
    {
        var sourceList = _activeTab switch
        {
            "arrivals" => _arrivals,
            "departures" => _departures,
            _ => _allBookings
        };
        var filtered = sourceList.AsEnumerable();
        if (!string.IsNullOrEmpty(_searchTerm)) { filtered = filtered.Where(b => b.GuestFullName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) || b.Id.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase)); }
        if (!string.IsNullOrEmpty(_statusFilter)) { filtered = filtered.Where(b => b.Status.Equals(_statusFilter, StringComparison.OrdinalIgnoreCase)); }
        if (_dateFilter.HasValue) { filtered = filtered.Where(b => b.CheckInDate.Date <= _dateFilter.Value.Date && b.CheckOutDate.Date > _dateFilter.Value.Date); }
        return filtered.ToList();
    }

    private void FilterLocalLists()
    {
        var today = DateTime.UtcNow.Date;
        _arrivals = _allBookings.Where(b => b.CheckInDate.Date == today).ToList();
        _departures = _allBookings.Where(b => b.CheckOutDate.Date == today).ToList();
    }

    private async Task ApplyFilters() => await Task.CompletedTask;

    private async Task ClearFilters()
    {
        _searchTerm = "";
        _dateFilter = null;
        _statusFilter = "";
        await ApplyFilters();
    }

    public void Dispose()
    {
        SignalRService.OnNewTicketReceived -= ReloadManagerTicketsWrapper;
        SignalRService.OnStatusChanged -= ReloadManagerTicketsWrapper;
        SignalRService.OnRoomStatusChanged -= HandleRoomStatusChanged;
    }
}